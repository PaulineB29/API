// 3.1 Créer le endpoint API : /api/trading-metrics
const express = require('express');
const router = express.Router();

// POST /api/trading-metrics - Sauvegarder les métriques
router.post('/', async (req, res) => {
    try {
        const {
            entreprise_id,
            date_analyse,
            normalized_fcf,
            dynamic_peg,
            earnings_quality,
            price_momentum_63d,
            volatility_30d,
            short_interest_ratio,
            squeeze_potential,
            quality_score,
            momentum_score,
            value_score,
            risk_adjusted_score
        } = req.body;

        const query = `
            INSERT INTO trading_metrics_avancees (
                entreprise_id, date_analyse, normalized_fcf, dynamic_peg,
                earnings_quality, price_momentum_63d, volatility_30d,
                short_interest_ratio, squeeze_potential, quality_score,
                momentum_score, value_score, risk_adjusted_score
            ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13)
            ON CONFLICT (entreprise_id, date_analyse) 
            DO UPDATE SET
                normalized_fcf = EXCLUDED.normalized_fcf,
                dynamic_peg = EXCLUDED.dynamic_peg,
                earnings_quality = EXCLUDED.earnings_quality,
                price_momentum_63d = EXCLUDED.price_momentum_63d,
                volatility_30d = EXCLUDED.volatility_30d,
                short_interest_ratio = EXCLUDED.short_interest_ratio,
                squeeze_potential = EXCLUDED.squeeze_potential,
                quality_score = EXCLUDED.quality_score,
                momentum_score = EXCLUDED.momentum_score,
                value_score = EXCLUDED.value_score,
                risk_adjusted_score = EXCLUDED.risk_adjusted_score,
                created_at = NOW()
        `;

        const values = [
            entreprise_id, date_analyse, normalized_fcf, dynamic_peg,
            earnings_quality, price_momentum_63d, volatility_30d,
            short_interest_ratio, squeeze_potential, quality_score,
            momentum_score, value_score, risk_adjusted_score
        ];

        await pool.query(query, values);
        
        res.json({ success: true, message: 'Métriques de trading sauvegardées' });
        
    } catch (error) {
        console.error('Error saving trading metrics:', error);
        res.status(500).json({ success: false, error: error.message });
    }
});

// GET /api/trading-metrics/:symbol - Récupérer les métriques
router.get('/:symbol', async (req, res) => {
    try {
        const { symbol } = req.params;
        
        const query = `
            SELECT tm.*, e.symbole, e.nom, e.secteur
            FROM trading_metrics_avancees tm
            JOIN entreprises e ON tm.entreprise_id = e.id
            WHERE e.symbole = $1
            ORDER BY tm.date_analyse DESC
            LIMIT 1
        `;
        
        const result = await pool.query(query, [symbol]);
        
        if (result.rows.length === 0) {
            return res.status(404).json({ error: 'Métriques non trouvées' });
        }
        
        res.json(result.rows[0]);
        
    } catch (error) {
        console.error('Error fetching trading metrics:', error);
        res.status(500).json({ error: error.message });
    }
});
